<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
</head>
<body style="background-color: aliceblue;">
    <script>
        function onload() {
            const token = sessionStorage.getItem("token");

            const myHeaders = new Headers();
            myHeaders.append("Authorization", "Bearer " + token);

            const requestOptions = {
                method: "GET",
                headers: myHeaders
            };
            fetch("http://localhost:8080/admin/rest/get-allUser", requestOptions)
                .then((response) => response.json())
                .then((result) => {
                    const resp = result;
                    loadData(resp.body.users);
                })
                .catch((error) => console.error(error));

            function loadData(users) {
                const tbody = document.getElementById("content");
                tbody.innerHTML = '';
                if(users.length == 0) {
                    tbody.innerHTML = `<tr><td colspan="3" class="text-center">-- No Record --</td></tr>`;
                }else {
                    users.forEach(user => {
                    tbody.innerHTML = tbody.innerHTML + `<tr>
            			<td>${user.name}</td>
						<td>${user.email}</td>
                		<td>
                    		<button onclick="editUser('${user.id}')" class="btn btn-secondary">Edit</button>
                            <button onclick="deleteUser('${user.id}')" class="btn btn-danger">delete</button>
                		</td>
        		</tr>`
                })
                    
                }
            }
        } 
        onload();
        function deleteUser(id) {
            const token = sessionStorage.getItem("token");

            const myHeaders = new Headers();
            myHeaders.append("Authorization", "Bearer " + token);

            const requestOptions = {
                method: "DELETE",
                headers: myHeaders
            };
            fetch(`http://localhost:8080/admin/rest/delete-user/${id}`, requestOptions)
                .then((response) => response.text())
                .then((result) => {
                    alert(result);
                    onload();
                })
                .catch((error) => console.error(error));
        }
        function editUser(id) {
            if(document.getElementById("userId").value == "") {
                const divEl = document.getElementById("edit");
                const nameLabelEl = document.createElement("label");
                nameLabelEl.for="name";
                nameLabelEl.innerText="Name:";
                nameLabelEl.classList.add("form-label");
                const nameInputEl = document.createElement("input");
                nameInputEl.type="text";
                nameInputEl.id="name";
                nameInputEl.classList.add("form-control");
                const emailLabelEl = document.createElement("label");
                emailLabelEl.for="email";
                emailLabelEl.innerText="Email:";
                emailLabelEl.classList.add("form-label");
                const emailInputEl = document.createElement("input");
                emailInputEl.type="text";
                emailInputEl.id="email";
                emailInputEl.classList.add("form-control");
                const buttonEl = document.createElement("input");
                buttonEl.type="button";
                buttonEl.id="save";
                buttonEl.value="Save";
                buttonEl.classList.add("btn", "btn-primary");
                buttonEl.addEventListener("click", ()=>{
                    const name = document.getElementById("name").value;
                    const email = document.getElementById("email").value;
                    const userId = document.getElementById("userId").value;

                    const token = sessionStorage.getItem("token");

                    const myHeaders = new Headers();
                    myHeaders.append("Content-Type", "application/json");
                    myHeaders.append("Authorization", "Bearer " + token);

                    const requestOptions = {
                        method: "POST",
                        headers: myHeaders,
                        body: JSON.stringify({ "name": name, "email": email, "userId": userId}),
                        redirect: "follow"
                    };
                    fetch("http://localhost:8080/admin/rest/save-user", requestOptions)
                        .then((response) => response.text())
                        .then((result) => {
                            alert(result);
                            onload();
                        })
                        .catch((error) => console.error(error));
                });
                divEl.appendChild(nameLabelEl);
                divEl.appendChild(nameInputEl);
                divEl.appendChild(emailLabelEl);
                divEl.appendChild(emailInputEl);
                divEl.appendChild(buttonEl);
            }
            const token = sessionStorage.getItem("token");

            const myHeaders = new Headers();
            myHeaders.append("Authorization", "Bearer " + token);

            const requestOptions = {
                method: "GET",
                headers: myHeaders
            };
            fetch(`http://localhost:8080/admin/rest/get-userById/${id}`, requestOptions)
                .then((response) => response.json())
                .then((result) => {
                    document.getElementById("name").value = result.body.user.name;
                    document.getElementById("email").value = result.body.user.email;
                    document.getElementById("userId").value = result.body.user.id;
                })
                .catch((error) => console.error(error));
        }
        function propertyListPage() {          
            const token = sessionStorage.getItem("token");

            const myHeaders = new Headers();
            myHeaders.append("Authorization", "Bearer "+token);
            const requestOptions = {
                method: "GET",
                headers: myHeaders,
                redirect: "follow"
            };
            fetch("http://localhost:8080/admin/property-list", requestOptions)
            .then((response) => response.text())
            .then((html) => {
                 document.write(html);
                 document.close();
            })
            .catch((error) => console.error(error));
        }
    </script>
    <header>
        <div class="row border fixed-top" style="background-color:antiquewhite;">
            <div class="col md-1"></div>
            <div class="col md-1"></div>
            <div class="col md-1"></div>
            <div class="col md-1"></div>
            <div class="col md-1"></div>
            <div class="col md-1"></div>
            <div class="col md-4 m-3">
                <nav class="nav"><a href="" class="nav-link" onclick="propertyListPage()">Property List</a></nav>
            </div>
            <div class="col md-2 m-3 border-start border-dark-subtle">
                <a href="http://localhost:8080/" class="btn btn-danger link-dark"><svg
                        xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px"
                        fill="#1f1f1f" class="d-inline">
                        <path
                            d="M216-144q-29.7 0-50.85-21.15Q144-186.3 144-216v-528q0-29.7 21.15-50.85Q186.3-816 216-816h264v72H216v528h264v72H216Zm432-168-51-51 81-81H384v-72h294l-81-81 51-51 168 168-168 168Z" />
                    </svg></svg>Logout</a>
            </div>
        </div>
    </header>
    <main>
        <div class="container border border-top-0 border-secondary p-5 mt-5">
            <div class="border-bottom border-black">
                <h1>User List</h1>
            </div><br />
            <div id="edit">
                <input type="hidden" id="userId" />
            </div>
            <table class="table table-success table-striped">
                <thead>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Actions</th>
                </thead>
                <tbody id="content">
                </tbody>
            </table>
        </div>
    </main>
    
</body>
</html>